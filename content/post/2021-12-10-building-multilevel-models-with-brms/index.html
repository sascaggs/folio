---
title: Multilevel models with {brms}
author: Shane A. Scaggs
date: '2021-12-10'
slug: building-multilevel-models-with-brms
categories:
  - Statistics
tags:
  - Bayes
  - Modeling
  - Data Analysis
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<p>Multilevel models are a kind of statistical model that estimate parameters at more than one level. They are very useful kind of model because they are suited to the hierarchical and nested organization of the world around us. In this post, I will demonstrate how to build, describe, and compare multilevel models using tools from <code>brms</code>.</p>
<pre class="r"><code>options(mc.cores = parallel::detectCores(), scipen = 0)
#install.packages(&#39;rstan&#39;)
#install.packages(&#39;brms&#39;)
library(brms)
library(tidybayes)
library(tidyverse)</code></pre>
<p>For this demonstration, I will analyze the <code>palmerpenguins</code> dataset made available on github by <a href="https://allisonhorst.github.io/palmerpenguins/articles/intro.html#exploring-factors-1">Allison Horst</a>. These data describe multiple species of penguins – Chinstrap, Gentoo, and Adelie – that inhabit Antarctica.</p>
<pre class="r"><code>#remotes::install_github(&#39;allisonhorst/palmerpenguins&#39;)
library(palmerpenguins)
data(&#39;penguins&#39;)
d &lt;- penguins
head(d)</code></pre>
<pre><code>## # A tibble: 6 x 8
##   species island bill_length_mm bill_depth_mm flipper_length_~ body_mass_g sex  
##   &lt;fct&gt;   &lt;fct&gt;           &lt;dbl&gt;         &lt;dbl&gt;            &lt;int&gt;       &lt;int&gt; &lt;fct&gt;
## 1 Adelie  Torge~           39.1          18.7              181        3750 male 
## 2 Adelie  Torge~           39.5          17.4              186        3800 fema~
## 3 Adelie  Torge~           40.3          18                195        3250 fema~
## 4 Adelie  Torge~           NA            NA                 NA          NA &lt;NA&gt; 
## 5 Adelie  Torge~           36.7          19.3              193        3450 fema~
## 6 Adelie  Torge~           39.3          20.6              190        3650 male 
## # ... with 1 more variable: year &lt;int&gt;</code></pre>
<div id="the-most-simple-model" class="section level2">
<h2>The most simple model</h2>
<p>The values that I want to predict in this data set are body mass, measured in grams (<code>body_mass_g</code>). The simplest model we could use to predict body mass would contain a single parameter, the <code>Intercept</code>, sometimes also called <span class="math inline">\(\alpha\)</span> in statistical notation. This model estimates a grand mean body mass of all penguins in the data set, and the uncertainty around the estimate. We specify this model in <code>brm</code> using the formula: <code>body_mass_g ~ 1</code>. This is <em>not a multilevel</em> model because we are estimating two parameters – <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span> – only at the population level.</p>
<pre class="r"><code>mod0 &lt;- brm(data = d, family = gaussian(),
            body_mass_g ~ 1)</code></pre>
<p>We can examine the estimates using <code>posterior_summary()</code> – which returns the estimates for all estimated parameters in a <code>&lt;brmsfit&gt;</code> object. The model estimates mean body mass (g) to be <code>4200.43</code> with <code>44.09</code> grams of error. This comparable to the value of <code>4201.75</code> computed using <code>base</code> <code>R</code>. The Gaussian family also estimates a <code>sigma</code> value of <code>802.90</code>, which is comparable to the standard deviation (sd = <code>801.95</code>)</p>
<pre class="r"><code>posterior_summary(mod0)</code></pre>
<pre><code>##               Estimate Est.Error       Q2.5      Q97.5
## b_Intercept  4200.4297 44.092696  4113.5505  4288.2908
## sigma         802.9045 31.099490   744.5619   867.5428
## lp__        -2781.4773  1.027485 -2784.2627 -2780.4728</code></pre>
<p>Another way to describe the mean and uncertainty of the <code>Intercept</code> parameter is to generate draws from the posterior and graph the distribution of body mass values. There are many ways to generate draws and graph distributions, but a full description of these methods is beyond the scope of this post.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-7"></span>
<img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-7-1.png" alt="Posterior distribution of body mass (g)." width="384" />
<p class="caption">
Figure 1: Posterior distribution of body mass (g).
</p>
</div>
</div>
<div id="species-variation-fixed-and-random" class="section level2">
<h2>Species variation, fixed and random</h2>
<p>A sensible biologist might point out that body mass probably varies across each species of penguin. We can assess by adding a <strong>fixed effect</strong> of species to our model. This will estimate how mean at the population level varies across groups (i.e., multiple intercepts). It will not, however, help us understand how body mass varies <em>within</em> each species. To do that, we need estimate <strong>random intercepts</strong> for each species group. We’ll fit both models to illustrate the difference.</p>
<p>For the fixed effect model, we add a covariate for species to our model formula:</p>
<blockquote>
<p><code>body_mass_g ~ -1 + species</code></p>
</blockquote>
<p>This formula will estimate a fixed intercept for each of the species groups in the dataset. The <code>-1</code> tells <code>brms</code> not to estimate an overall mean, but instead to estimate separate means.</p>
<pre class="r"><code>mod1a &lt;- brm(data = d, family = gaussian(),
            body_mass_g ~ -1 + species)</code></pre>
<p>We can examine the estimates by calling the model object inside the <code>fixef()</code> function.</p>
<pre class="r"><code>fixef(mod1a)</code></pre>
<pre><code>##                  Estimate Est.Error     Q2.5    Q97.5
## speciesAdelie    3700.254  37.18079 3627.524 3772.018
## speciesChinstrap 3733.690  55.54087 3624.735 3843.410
## speciesGentoo    5075.702  41.61432 4993.328 5157.074</code></pre>
<p>Here we see that <code>Adelie</code> and <code>Chinstrap</code> have relatively similar mean and error values, while the mean for <code>Gentoo</code> is much larger. Just how much body mass measurements overlap is every easier to see if we graph the posterior.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-11"></span>
<img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-11-1.png" alt="Posterior distribution of body mass (g) for each penguin species." width="384" />
<p class="caption">
Figure 2: Posterior distribution of body mass (g) for each penguin species.
</p>
</div>
<p>Although the graph makes it clear that there are mean differences between species, the shape of the curve is based on the same <code>sigma</code> value for the entire population. Thus, our model <em>only</em> accounts for between species variation. To describe variation within and between species, we need allow random intercepts for each species.</p>
<p>We estimate random intercepts using a formula with following term:</p>
<blockquote>
<p><code>body_mass_g ~(1|species)</code></p>
</blockquote>
<pre class="r"><code>mod1b &lt;- brm(data = d, family = gaussian(),
            body_mass_g ~ (1|species))</code></pre>
<p>To view this model, we use <code>ranef()</code> – for random effects – instead of <code>fixef()</code>.</p>
<pre class="r"><code>ranef(mod1b)</code></pre>
<pre><code>## $species
## , , Intercept
## 
##            Estimate Est.Error        Q2.5     Q97.5
## Adelie    -436.8614  475.0701 -1393.77848  519.5484
## Chinstrap -402.0018  476.5776 -1362.65912  560.6884
## Gentoo     935.9014  475.6870   -23.49855 1896.1221</code></pre>
<p>We see a similar structure but with very different estimates and error. The estimate represent differences between the mean body size for each species (level 1) and the population mean (level 2). Let’s plot this posterior and see how it compares to <code>mod1a</code>.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-15"></span>
<img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-15-1.png" alt="Posterior distribution of random intercepts of body mass (g) for each penguin species." width="384" />
<p class="caption">
Figure 3: Posterior distribution of random intercepts of body mass (g) for each penguin species.
</p>
</div>
<p>The distributions in Figure 3 look hardly different from the distributions in Figure 2. What is this?? Well these figures both show the distribution of estimated mean values. The real variation lies in the uncertainty around these value. This we can see by visualizing the uncertainty.</p>
</div>

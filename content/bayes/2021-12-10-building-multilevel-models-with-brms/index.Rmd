---
title: Building multilevel models with {brms}
author: Shane A. Scaggs
date: '2021-12-10'
slug: building-multilevel-models-with-brms
categories:
  - Statistics
tags:
  - Bayes
  - Modeling
  - Data Analysis
---

Multilevel models are a kind of statistical model that estimate parameters at more than one level. They are very useful kind of model because they are suited to the hierarchical and nested organization of the world around us.  In this post, I will demonstrate how to build, describe, and compare multilevel models using tools from `brms`. 

```{r, message=F, warning=FALSE}
options(mc.cores = parallel::detectCores(), scipen = 0)
#install.packages('rstan')
#install.packages('brms')
library(brms)
library(tidybayes)
library(tidyverse)
```

```{r, echo=F}
sas_nogrid <- sas_nogrid <- theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
                    panel.border = element_rect(color='black', size=1.2, fill = '#00000000'), 
                    panel.grid = element_blank(), 
                    text = element_text(family = 'mono', size = 14),
                    axis.ticks.length = unit(0.15, 'inch'), 
                    axis.ticks = element_line(size=0.7), 
                    strip.background = element_rect(fill = 'black', color = 'black'), 
                    strip.text = element_text(color='white', face = 'bold'))

```



For this demonstration, let's model the `palmerpenguins` dataset made available on github by [Allison Horst](https://allisonhorst.github.io/palmerpenguins/articles/intro.html#exploring-factors-1). These data contain morphometrics for three species of penguins -- Chinstrap, Gentoo, and Adelie -- and the names of the islands they inhabit in Antarctica. 

```{r, message=F, warning=F}
#remotes::install_github('allisonhorst/palmerpenguins')
library(palmerpenguins)
data('penguins')
d <- penguins
head(d)
```

## Start simple

Let's model penguin body mass (`body_mass_g`). A simple starting model would be to estimate the central tendency and variation in body masses across all penguins. We can do this by estimating the parameters mu ($\mu$) and sigma ($\sigma$) with a Gaussian family. 

For now, we will use the default `brms` priors.  You can view them by calling the model formula, data, and family:

```{r, warning=F}
get_prior(body_mass_g ~ 1, 
          family = gaussian(), data = d)
```

The model formula is simple: `body_mass_g ~ 1`.  

```{r, warning=F, message=F, eval=F}
mod0 <- brm(family = gaussian(), data = d,
            body_mass_g ~ 1)
```

```{r, warning=F, message=F,echo=F}
mod0 <- brm(data = d, family = gaussian(),
            body_mass_g ~ 1, 
            file = "~/Shane's Projects/folio/content/post/2021-12-10-building-multilevel-models-with-brms/models/Model0-Intercept",
            file_refit = 'on_change')
```

We can examine the posterior estimates using `posterior_summary()`, which returns all fixed and random effect estimate by a `<brmsfit>` object. According to this model, the mean body mass (g) of all the Penguins is `4200.43`, surrounded by `44.09` grams of error. This value is comparable to the value computed using `base` `R` (mean = ``r round(mean(d$body_mass_g, na.rm=T), digits=2)``). This model also estimates a `sigma` value of `802.90`, which is comparable to the standard deviation (sd  = ``r round(sd(d$body_mass_g, na.rm=T),digits=2)``)

```{r}
posterior_summary(mod0)
```

If we generate `4000` draws from this model, and graph them, the distribution looks something like this:

```{r, echo=F, fig.width=4, fig.height=3, fig.cap='Posterior distribution of body mass (g).', fig.align='center'}
mod0 %>% spread_draws(b_Intercept) %>%
    ggplot(aes(b_Intercept)) + geom_density(fill='#3300ff33', color='#3300ff', lwd=1.2) + sas_nogrid + geom_vline(xintercept = 4200.43, lty=2)
```


## Species variation, fixed and random

A sensible biologist might point out that body mass probably varies across each species of penguin. We can assess this by adding a **fixed effect** of species to our model that will estimate the body mass for each species. It will not, however, help us understand how body mass varies *within* each species. To do that, we need estimate **random intercepts** for each species group. We'll fit both models to illustrate the difference. 

For the fixed effect model, we add the `species` factor to our model formula: 

> `body_mass_g ~ 1 + species`

to estimate a fixed intercept for each of the species groups in the dataset.   

```{r, warning=F, message=F, eval=F}
mod1a <- brm(data = d, family = gaussian(),
            body_mass_g ~ 1 + species)
```

```{r, warning=F, message=F,echo=F}
mod1a <- brm(data = d, family = gaussian(),
            body_mass_g ~ 1 + species, 
            file = "~/Shane's Projects/folio/content/post/2021-12-10-building-multilevel-models-with-brms/models/Model1a-FixedSpecies",
            file_refit = 'on_change')
```

We can examine the estimates by calling the model object inside the `fixef()` function. 
```{r}
fixef(mod1a)
```

Here we see that `Adelie` and `Chinstrap` have relatively similar mean and error values, while the mean for `Gentoo` is much larger. Just how much body mass measurements overlap is every easier to see if we graph the posterior. 

```{r, echo=F, fig.width=4, fig.height=3, fig.cap='Posterior distribution of body mass (g) for each penguin species.', fig.align='center'}
mod1a %>% 
    spread_draws(b_speciesAdelie, b_speciesChinstrap, b_speciesGentoo) %>%
    select(b_speciesAdelie, b_speciesChinstrap, b_speciesGentoo) %>%
    gather(key = species, value = body_mass) %>%
    mutate(species = str_remove(species, 'b_species')) %>%
    ggplot(aes(body_mass)) + geom_density(aes(fill=species, color=species), lwd=1.2, alpha=0.4) + 
    sas_nogrid + scico::scale_fill_scico_d(palette = 'hawaii', end=0.8) + scico::scale_color_scico_d(palette = 'hawaii', end=0.8) + 
    theme(legend.position = c(0.55,0.5))
```
Although the graph makes it clear that there are mean differences between species, the shape of the curve is based on the same `sigma` value for the entire population. Thus, our model *only* accounts for between species variation. To describe variation within and between species, we need allow random intercepts for each species. 

We estimate random intercepts using a formula with following term: 

> `body_mass_g ~(1|species)`

```{r, warning=F, message=F, eval=F}
mod1b <- brm(data = d, family = gaussian(),
            body_mass_g ~ (1|species))
```

```{r, warning=F, message=F,echo=F}
mod1b <- brm(data = d, family = gaussian(),
            body_mass_g ~ (1|species), 
            file = "~/Shane's Projects/folio/content/post/2021-12-10-building-multilevel-models-with-brms/models/Model1b-RandomSpecies",
            file_refit = 'on_change')
```

To view this model, we use `ranef()` -- for random effects -- instead of `fixef()`. 

```{r}
ranef(mod1b)
```
We see a similar structure but with very different estimates and error. The estimate represent differences between the mean body size for each species (level 1) and the population mean (level 2). Let's plot this posterior and see how it compares to `mod1a`. 

```{r, echo=F, fig.width=4, fig.height=3, fig.cap='Posterior distribution of random intercepts of body mass (g) for each penguin species.', fig.align='center'}
mod1b %>% 
    spread_draws(b_Intercept, r_species[species,]) %>%
    mutate(body_mass = b_Intercept + r_species) %>%
    ggplot(aes(body_mass)) + geom_density(aes(fill=species, color=species), lwd=1.2, alpha=0.4) + 
    sas_nogrid + scico::scale_fill_scico_d(palette = 'hawaii', end=0.8) + scico::scale_color_scico_d(palette = 'hawaii', end=0.8) + 
    theme(legend.position = c(0.55,0.5))
```

The distributions in Figure 3 look hardly different from the distributions in Figure 2. What is this?? Well these figures both show the distribution of estimated mean values. The real variation lies in the uncertainty around these value. This we can see by visualizing the uncertainty. 





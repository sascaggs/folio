---
title: Building simple multilevel models with {brms}
author: Shane A. Scaggs
date: '2021-12-10'
slug: building-simple-multilevel-models-with-brms
categories:
  - Statistics
tags:
  - Bayes
  - Modeling
  - Data Analysis
---

Multilevel models are a kind of statistical model that estimate parameters at more than one level. They are very useful kind of model because they are suited to the hierarchical and nested organization of the world around us.  In this post, I will demonstrate how to build, describe, and compare multilevel models using tools from `brms`. 

```{r, message=F, warning=FALSE}
options(mc.cores = parallel::detectCores(), scipen = 0)
#install.packages('rstan')
#install.packages('brms')
library(brms)
library(tidybayes)
library(tidyverse)
```

```{r, echo=F}
sas_nogrid <- sas_nogrid <- theme(panel.background = element_rect(fill = 'white', colour = 'black'), 
                                  panel.border = element_rect(color='black', size=1.2, fill = '#00000000'), 
                                  panel.grid = element_blank(), 
                                  text = element_text(family = 'mono', size = 14, color = 'black'),
                                  axis.ticks.length = unit(0.15, 'inch'), 
                                  axis.ticks = element_line(size=0.7), 
                                  strip.background = element_rect(fill = 'black', color = 'black'), 
                                  strip.text = element_text(color='white', face = 'bold'))

```



For this demonstration, let's model the `palmerpenguins` dataset made available on github by [Allison Horst](https://allisonhorst.github.io/palmerpenguins/articles/intro.html#exploring-factors-1). These data contain morphometrics for three species of penguins -- Chinstrap, Gentoo, and Adelie -- and the names of the islands they inhabit in Antarctica. 

```{r, message=F, warning=F}
#remotes::install_github('allisonhorst/palmerpenguins')
library(palmerpenguins)
data('penguins')
d <- penguins
head(d)
```

## Start simple

Let's model penguin body mass (`body_mass_g`). A simple starting model would be to estimate the central tendency and variation in body masses across all penguins. We can do this by estimating the parameters mu ($\mu$) and sigma ($\sigma$) with a Gaussian family. 

For now, we will use the default `brms` priors.  You can view them by calling the model formula, data, and family:

```{r, warning=F}
get_prior(body_mass_g ~ 1, 
          family = gaussian(), data = d)
```

The model formula is simple: `body_mass_g ~ 1`.  

```{r, warning=F, message=F, eval=F}
mod0 <- brm(family = gaussian(), data = d,
            body_mass_g ~ 1)
```

```{r, warning=F, message=F,echo=F}
mod0 <- brm(data = d, family = gaussian(),
            body_mass_g ~ 1, 
            file = "~/Shane's Projects/folio/content/bayes/2021-12-10-building-multilevel-models-with-brms/models/Model0-Intercept",
            file_refit = 'on_change')
```

We can examine the posterior estimates using `posterior_summary()`, which returns all fixed and random effect estimate by a `<brmsfit>` object. According to this model, the mean body mass (g) of all the Penguins is `4200.43`, surrounded by `44.09` grams of error. This value is comparable to the value computed using `base` `R` (mean = ``r round(mean(d$body_mass_g, na.rm=T), digits=2)``). This model also estimates a `sigma` value of `802.90`, which is comparable to the standard deviation (sd  = ``r round(sd(d$body_mass_g, na.rm=T),digits=2)``)

```{r}
posterior_summary(mod0)
```

If we generate `4000` draws from this model, and graph them, the distribution looks something like this:

```{r, echo=F, fig.width=4, fig.height=3, fig.cap='Posterior distribution of body mass (g).', fig.align='center'}
mod0 %>% spread_draws(b_Intercept) %>%
  ggplot(aes(b_Intercept)) + geom_density(fill='#3300ff33', color='#3300ff', lwd=1.2) + sas_nogrid + geom_vline(xintercept = 4200.43, lty=2)
```


## Species variation, fixed and random

A sensible biologist might point out that body mass probably varies across each species of penguin. We can assess this by adding a **fixed effect** of species to our model that will estimate the body mass for each species. It will not, however, help us understand how body mass varies *within* each species. To do that, we need estimate **random intercepts** for each species group. We'll fit both models to illustrate the difference. 

For the fixed effect model, we add the `species` factor to our model formula: 

> `body_mass_g ~ 1 + species`

to estimate a fixed intercept for each of the species groups in the dataset.   

```{r, warning=F, message=F, eval=F}
mod1a <- brm(data = d, family = gaussian(),
             body_mass_g ~ 1 + species)
```

```{r, warning=F, message=F,echo=F}
mod1a <- brm(data = d, family = gaussian(),
             body_mass_g ~ 1 + species, 
             file = "~/Shane's Projects/folio/content/bayes/2021-12-10-building-multilevel-models-with-brms/models/Model1a-FixedSpecies",
             file_refit = 'on_change')
```

We can examine the estimates by calling the model object inside the `fixef()` function. 
```{r}
fixef(mod1a)
```

Here we see that the body mass of `Adelie` --  the reference category for `Intercept` -- and `Chinstrap` differ by just over `30` grams, while the mean for `Gentoo` is more than `1000` grams larger. Just how much these body mass measurements overlap is easier to see if we graph the posterior. 

```{r, echo=F, fig.width=5, fig.height=3, fig.cap='Posterior distribution of body mass (g) for each penguin species.', fig.align='center'}
mod1a %>% 
  spread_draws(b_Intercept, b_speciesChinstrap, b_speciesGentoo) %>%
  select(b_Intercept, b_speciesChinstrap, b_speciesGentoo) %>%
  mutate(Adelie = b_Intercept, 
         Chinstrap = b_Intercept + b_speciesChinstrap, 
         Gentoo = b_Intercept + b_speciesGentoo) %>%
  select(Adelie, Chinstrap, Gentoo) %>%
  gather(key = species, value = body_mass) %>%
  ggplot(aes(body_mass)) + geom_density(aes(fill=species, color=species), lwd=1.2, alpha=0.4) + 
  sas_nogrid + scico::scale_fill_scico_d(palette = 'hawaii', end=0.8) + scico::scale_color_scico_d(palette = 'hawaii', end=0.8) + 
  labs(x='body_mass_g')
```

To estimate random intercepts for each species, rather than fixed intercepts, we use the following model formula:

> `body_mass_g ~(1|species)`

```{r, warning=F, message=F, eval=F}
mod1b <- brm(data = d, family = gaussian(),
             body_mass_g ~ (1|species))
```

```{r, warning=F, message=F,echo=F}
mod1b <- brm(data = d, family = gaussian(),
             body_mass_g ~ (1|species), 
             file = "~/Shane's Projects/folio/content/bayes/2021-12-10-building-multilevel-models-with-brms/models/Model1b-RandomSpecies",
             file_refit = 'on_change')
```

This model estimates a "global" fixed intercept: 

```{r}
fixef(mod1b)
```

and then separate random intercepts for each species, reported as differences from the global intercept:

```{r}
ranef(mod1b)
```

Ultimately, this model will produce posterior distributions that look very similar to the fixed effect model: 

```{r, echo=F, fig.width=5, fig.height=3, fig.cap='Posterior distribution of body mass (g) based on random intercepts for each penguin species.', fig.align='center'}
mod1b %>% 
  spread_draws(b_Intercept, r_species[species,]) %>%
  mutate(body_mass = b_Intercept + r_species) %>%
  ggplot(aes(body_mass)) + geom_density(aes(fill=species, color=species), lwd=1.2, alpha=0.4) + 
  sas_nogrid + scico::scale_fill_scico_d(palette = 'hawaii', end=0.8) + scico::scale_color_scico_d(palette = 'hawaii', end=0.8) 
```

However, there is a key difference between the fixed and random effects models. The random effects model has a much greater amount of uncertainty when compared to the fixed effects. This can be seen in the following dotplot, which shows the coefficient estimates for each model and the error around these estimates.

```{r, warning=F, message=F, echo=F, fig.width=6, fig.height=3, fig.cap='Intercept and beta coefficients fixed and random effects models. Lines indicate estimated error.', fig.align='center'}

fe <- as.data.frame(fixef(mod1a)[,1:2])
fe$Model <- 'fixed'
rownames(fe) <- c('Adelie\n(Intercept)','Chinstrap','Gentoo')

re <- as.data.frame((ranef(mod1b)$species)[,1:2,])
re$Model <- 'random'
re[1,1] <- -436.8614 + 4137.384
re[1,2] <- mean(c(475.0701, 474.9684))
rownames(re) <- c('Adelie\n(Intercept)','Chinstrap','Gentoo')
df <- rbind(fe,re)
df$species <- rownames(df)

df %>% 
  mutate(species = str_remove(species, '1')) %>%
  ggplot(aes(Estimate, species)) + 
  geom_point(aes(color=Model),pch=21, position = position_dodge(width = 0.5)) + sas_nogrid + 
  geom_errorbar(aes(xmin = Estimate - Est.Error, 
                    xmax = Estimate + Est.Error,
                    color = Model), 
                position = position_dodge(width = 0.5),
                size = 0.7, width = 0) + 
  scico::scale_color_scico_d(palette = 'lajolla', begin = 0.6) + 
  geom_vline(xintercept = 0, lty=2) + labs(y='')
  
  
```

It is also noteworthy that the fixed effects model, suggested that `Chinstrap` was larger, on average, than `Adelie`. The random effects model, however, shows the opposite. 

## Epilogue 

I am researcher who was trained in frequentist statistics and then shifted to Bayesian statistics. Having transitioned, one of the most glaring differences (among many others) I've noticed is that in frequentism, there is a strong emphasis on coefficient effects, and a weak emphasis on uncertainty and model error. I find this to be the opposite in Bayesian statistics which has a central goal of understanding and incorporating model uncertainty. 



